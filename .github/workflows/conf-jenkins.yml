name: Configurar Jenkins completo en Docker

on:
  workflow_dispatch:

jobs:
  setup_jenkins:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Instalar Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible sshpass curl openjdk-11-jdk

      - name: Esperar a que Jenkins estÃ© listo
        run: |
          until curl -s -f http://$JENKINS_URL/login > /dev/null; do
            echo "Esperando Jenkins..."
            sleep 10
          done
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}

      - name: Obtener Crumb de Jenkins (CSRF token)
        id: get_crumb
        run: |
          crumb=$(curl -s --user admin:${{ secrets.JENKINS_API_TOKEN }} "http://$JENKINS_URL/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,':',//crumb)")
          echo "::set-output name=crumb::$crumb"
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}

      - name: Agregar credenciales Docker Hub
        run: |
         curl --fail -X POST "http://$JENKINS_URL/credentials/store/system/domain/_/createCredentials" \
          --user admin:${{ secrets.JENKINS_API_TOKEN }} \
          -H "Content-Type: application/json" \
          -d '{
            "credentials": {
              "scope": "GLOBAL",
              "id": "dockerhub-cred",
              "username": "dylalva",
              "password": "'"${{ secrets.DOCKER_PASSWORD }}"'",
              "description": "Docker Hub Credentials",
              "$class": "com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl"
            }
          }'

        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}

      - name: Agregar credenciales Azure Service Principal
        run: |
          curl --fail -X POST "http://$JENKINS_URL/credentials/store/system/domain/_/createCredentials" \
          --user admin:${{ secrets.JENKINS_API_TOKEN }} \
          -H "${{ steps.get_crumb.outputs.crumb }}" \
          -H "Content-Type: application/json" \
          -d '{
            "": "0",
            "credentials": {
              "scope": "GLOBAL",
              "id": "azure-service-principal",
              "subscriptionId": "'"${{ secrets.AZURE_SUBSCRIPTION_ID }}"'",
              "clientId": "'"${{ secrets.AZURE_CLIENT_ID }}"'",
              "clientSecret": "'"${{ secrets.AZURE_CLIENT_SECRET }}"'",
              "tenant": "'"${{ secrets.AZURE_TENANT_ID }}"'",
              "description": "Azure Service Principal Credentials",
              "$class": "com.microsoft.azure.credentials.AzureServicePrincipal"
            }
          }'
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}

      - name: Crear pipeline Jenkins
        run: |
          curl --fail -X POST "http://$JENKINS_URL/createItem?name=ci-cd-kube" \
          --user admin:${{ secrets.JENKINS_API_TOKEN }} \
          -H "${{ steps.get_crumb.outputs.crumb }}" \
          -H "Content-Type: application/xml" \
          --data-binary @infrastructure/job-config.xml
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}