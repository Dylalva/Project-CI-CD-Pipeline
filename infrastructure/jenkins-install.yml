---
- name: Configurar Jenkins en contenedor Docker existente
  hosts: jenkins_vm
  become: true

  tasks:
    - name: Instalar Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Asegurar que Docker esté iniciado y habilitado
      service:
        name: docker
        state: started
        enabled: yes

    - name: Crear script Groovy para crear usuario admin en VM temporalmente
      copy:
        dest: /tmp/basic-security.groovy
        content: |
          import jenkins.model.*
          import hudson.security.*

          def instance = Jenkins.getInstance()

          def hudsonRealm = new HudsonPrivateSecurityRealm(false)
          hudsonRealm.createAccount("admin", "admin_password")  # Cambia la contraseña por una segura
          instance.setSecurityRealm(hudsonRealm)

          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)

          instance.save()

    - name: Crear carpeta init.groovy.d dentro del contenedor Jenkins
      shell: docker exec jenkins mkdir -p /var/jenkins_home/init.groovy.d

    - name: Copiar script Groovy dentro del contenedor Jenkins
      shell: docker cp /tmp/basic-security.groovy jenkins:/var/jenkins_home/init.groovy.d/basic-security.groovy

    - name: Reiniciar contenedor Jenkins para aplicar configuración
      docker_container:
        name: jenkins
        state: started
        recreate: yes